defvarp showevents 0 2 2
defvarp eventintime 0 250 $varidxmax
defvarp eventouttime 0 10000 $varidxmax
defvarp eventfadetime 0 500 $varidxmax
defvarp eventlines 0 6 $varidxmax
defvarp eventlinesopen 0 7 $varidxmax
deffvarp eventblend 0 1 1

ui_hud_events = [
    if $showevents [
        local event_texth
        uiclip 0 0 0 0 [uiclipforced 1; uitext "Dummy" $ui_texttiny [event_texth = $uilasth]]
        uivlist 0 [
            uistyle lefttop
            loopevents (- $eventlines) 0 event_id [
                local event_time; event_time = (geteventmillis $event_id)
                local event_millis; event_millis = (- $totalmillis $event_time)
                local event_blend; event_blend = $eventblend
                local event_growth; event_growth = 1.0
                caseif (&& $eventouttime (> $event_millis $eventouttime)) [
                    local event_ctime; event_ctime = (- $event_millis $eventouttime)
                    if (&& $eventfadetime (< $event_ctime $eventfadetime)) [
                        event_growth = (-f 1 (divf $event_ctime $eventfadetime))
                        event_blend = (clampf (*f $event_growth $eventblend) 0 1)
                    ] [ event_blend = 0 ]
                ] (&& $eventintime (< $event_millis $eventintime)) [
                    event_growth = (divf $event_millis $eventintime)
                    event_blend = (clampf (*f $event_growth $eventblend) 0 1)
                ]
                if (>f $event_blend 0.0) [
                    local event_client; event_client = (geteventclient $event_id)
                    local event_colour; event_colour = 0
                    loopwhile event_clidx $event_client [! $event_colour] [
                        event_clientid = (geteventclient $event_id $event_clidx $EV_P_CN)
                        if (= $focusedplayer $event_clientid) [ event_colour = 0xFF282810 ]
                    ]
                    local event_obj
                    event_obj = [
                        uitext (geteventstr $event_id) $ui_texttiny [
                            uistyle leftmiddle
                            uitextalign -1
                        ]
                    ]
                    local event_type; event_type = (geteventtype $event_id)
                    local event_subtype; event_subtype = (geteventsubtype $event_id)
                    if (= $showevents 2) [
                        case $event_type $EV_FRAG [
                            event_obj = [
                                local event_extra; event_extra = 0
                                loop event_attackid (- $event_client 1) [
                                    if $event_extra [
                                        uitext "+" $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                    ]
                                    uitext (geteventname $event_id (+ $event_attackid 1) 3 0) $ui_texttiny [
                                        uistyle leftmiddle
                                        uitextalign -1
                                        if $event_extra [ uicolourscale 0xD0D0D0 ]
                                    ]
                                    event_extra = 1
                                ]
                                local event_weap; event_weap = (geteventinfo $event_id 0)
                                if (>= $event_weap 0) [
                                    local event_weapon; event_weapon = (at $weapname $event_weap)
                                    uiimage (concatword "<rotate:4>" $[@[event_weapon]tex]) $[@[event_weapon]colour] 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                ] [
                                    if (geteventinfo $event_id 5) [
                                        uiimage $burntex (getclientrescolour $focusedplayer $PULSE_BURN) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                    if (geteventinfo $event_id 6) [
                                        uiimage $bleedtex (getclientrescolour $focusedplayer $PULSE_BLEED) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                    if (geteventinfo $event_id 7) [
                                        uiimage $shocktex (getclientrescolour $focusedplayer $PULSE_SHOCK) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ]
                                if (!= (geteventclient $event_id 0 $EV_P_CN) (geteventclient $event_id 1 $EV_P_CN)) [
                                    if (&& (! (& $mutators (<< 1 $G_M_FFA))) (= (geteventclient $event_id 0 $EV_P_TEAM) (geteventclient $event_id 1 $EV_P_TEAM))) [
                                        uiimage $warningtex (getclientrescolour $focusedplayer $PULSE_WARN) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                    uitext (geteventname $event_id 0 3 0) $ui_texttiny [
                                        uistyle leftmiddle
                                        uitextalign -1
                                    ]
                                ] [
                                    uiimage $deadtex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                ]
                            ]
                        ] $EV_AFFINITY [
                            if (! $event_colour) [ event_colour = 0xFF102828 ]
                            case $gamemode $G_BOMBER [
                                case $event_subtype $EV_A_SECURE [
                                    event_obj = [
                                        uitext (geteventname $event_id 0 3 0) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                        uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $bombtakentex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ] $EV_A_DROP [
                                    event_obj = [
                                        uitext (geteventname $event_id 0 3 0) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                        uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $bombdroptex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ] $EV_A_SCORE [
                                    event_obj = [
                                        local event_goal; event_goal = (geteventinfo $event_id 1)
                                        local event_team; event_team = (getbomberteam $event_goal)
                                        uitext (geteventname $event_id 0 3 0) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                        uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $pointtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ] $EV_A_RESET [
                                    event_obj = [
                                        uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $pointtex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ] $EV_A_START [
                                    event_obj = [
                                        uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $pointtex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ]
                            ] $G_CAPTURE [
                                case $event_subtype $EV_A_SECURE [
                                    event_obj = [
                                        local event_flag; event_flag = (geteventinfo $event_id 0)
                                        local event_team; event_team = (getcaptureteam $event_flag)
                                        uitext (geteventname $event_id 0 3 0) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                        uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $flagtakentex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ] $EV_A_RETURN [
                                    event_obj = [
                                        local event_flag; event_flag = (geteventinfo $event_id 0)
                                        local event_team; event_team = (getcaptureteam $event_flag)
                                        uitext (geteventname $event_id 0 3 0) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                        uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $pointtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ] $EV_A_DROP [
                                    event_obj = [
                                        local event_flag; event_flag = (geteventinfo $event_id 0)
                                        local event_team; event_team = (getcaptureteam $event_flag)
                                        uitext (geteventname $event_id 0 3 0) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                        uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $flagdroptex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ] $EV_A_SCORE [
                                    event_obj = [
                                        local event_flag; event_flag = (geteventinfo $event_id 0)
                                        local event_team; event_team = (getcaptureteam $event_flag)
                                        local event_goal; event_goal = (geteventinfo $event_id 1)
                                        local event_base; event_base = (getcaptureteam $event_goal)
                                        uitext (geteventname $event_id 0 3 0) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                        uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $pointtex (getteamcolour $event_base) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ] $EV_A_RESET [
                                    event_obj = [
                                        local event_flag; event_flag = (geteventinfo $event_id 0)
                                        local event_team; event_team = (getcaptureteam $event_flag)
                                        uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $pointtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                ]
                            ] $G_DEFEND [
                                if (|| (= $event_subtype $EV_A_SECURE) (= $event_subtype $EV_A_RETURN)) [
                                    event_obj = [
                                        local event_extra; event_extra = 0
                                        loop event_attackid $event_client [
                                            if (= (geteventclient $event_id $event_attackid $EV_P_TEAM) (geteventinfo $event_id (? (= $event_subtype $EV_A_SECURE) 2 4))) [
                                                if $event_extra [
                                                    uitext "+" $ui_texttiny [
                                                        uistyle leftmiddle
                                                        uitextalign -1
                                                    ]
                                                ]
                                                uitext (geteventname $event_id $event_attackid 3 0) $ui_texttiny [
                                                    uistyle leftmiddle
                                                    uitextalign -1
                                                ]
                                                event_extra = 1
                                            ]
                                        ]
                                        uiimage $pointtex (getteamcolour (geteventinfo $event_id 1)) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uiimage $pointtex (getteamcolour (geteventinfo $event_id 2)) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                        uitext (getdefendname (geteventinfo $event_id 0)) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                    uiclip 0 0 0 0 [
                        uistyle lefttop
                        uispace 0 $ui_padtiny [
                            uistyle lefttop
                            uiborderedimageclamped $skinalphatex (? $event_colour $event_colour 0xDD000000) 0 $ui_texborder $ui_screenborder 0 0 [
                                uistyle lefttop
                                local event_height
                                uispace $ui_padsmall $ui_padsmaller [
                                    uistyle lefttop
                                    uihlist $ui_padsmall [
                                        uistyle leftmiddle
                                        event_obj
                                    ]
                                ]
                                uiprop [ uicolourblend $event_blend ]
                            ]
                        ]
                        event_height = (+f $ui_padsmaller $ui_padsmaller $uilasthprev)
                        uiclipsizeh (*f $event_height $event_growth)
                    ]
                ]
            ]
        ]
    ]
]